#!/bin/sh

THRESHOLD=20000 # Желаемый лимит памяти в КБ
SINGBOX="/etc/init.d/sing-box"

# Проверяем запущен ли singbox
if ! pgrep singbox >/dev/null 2>&1; then
  logger -t singbox-ui-memdoc "Singbox not running, exiting"
  exit 0
fi

restart_service_if_running() {
  SERVICE="$1"
  if [ -x "$SERVICE" ] && "$SERVICE" status | grep -q "running"; then
    logger "[memdoc] Restarting service $SERVICE due to low memory"
    "$SERVICE" restart
  fi
}

while true; do
  FREE_MEM=$(awk '/MemAvailable/ {print $2}' /proc/meminfo)

  if [ "$FREE_MEM" -le "$THRESHOLD" ]; then
    restart_service_if_running "$SINGBOX"
    sleep 10
  else
    sleep 1
  fi
done
