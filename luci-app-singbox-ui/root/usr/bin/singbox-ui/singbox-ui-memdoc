#!/bin/sh

THRESHOLD=15000 # 15MB в KB
SINGBOX="/etc/init.d/sing-box"
MIN_RESTART_INTERVAL=60 # Минимум 60 секунд между перезапусками
last_restart=0

logger -t singbox-memdoc "Starting memory monitor"

while true; do
    # Проверка работы singbox
    if ! pgrep singbox >/dev/null 2>&1; then
        logger -t singbox-memdoc "Singbox not running, exiting"
        exit 0
    fi

    FREE_MEM=$(awk '/MemAvailable/ {print $2}' /proc/meminfo)
    current_time=$(date +%s)

    if [ "$FREE_MEM" -le "$THRESHOLD" ]; then
        # Проверяем, когда был последний перезапуск
        if [ $((current_time - last_restart)) -ge $MIN_RESTART_INTERVAL ]; then
            logger -t singbox-memdoc "Low memory detected (${FREE_MEM}KB <= ${THRESHOLD}KB)"
            
            # Проверка статуса службы
            if [ -x "$SINGBOX" ] && $SINGBOX status | grep -q "running"; then
                logger -t singbox-memdoc "Restarting singbox service"
                $SINGBOX restart
                last_restart=$current_time
                
                # Даем время на восстановление
                sleep 30
            else
                logger -t singbox-memdoc "Service not running or not executable"
            fi
        else
            logger -t singbox-memdoc "Memory low but skip restart: too early"
        fi
    fi
    
    sleep 5 # Фиксированный интервал проверки
done